name: Cymax Product Scraper

on:
  workflow_dispatch:
    inputs:
      total_sitemaps:
        description: "Total sitemaps to process"
        default: "1"
      urls_per_sitemap:
        description: "Max URLs per sitemap"
        default: "50"
      max_workers:
        description: "Parallel workers"
        default: "2"

jobs:
  scrape:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget gnupg ca-certificates \
            libnss3 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libxkbcommon0 \
            libxcomposite1 libxdamage1 libxrandr2 \
            libgbm1 libasound2 libpangocairo-1.0-0 \
            libpango-1.0-0 libcairo2 libgdk-pixbuf2.0-0 \
            xvfb unzip

      - name: Install Chrome
        run: |
          # Install Google Chrome
          wget -q -O /tmp/chrome.deb \
            "https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
          sudo apt-get install -y /tmp/chrome.deb
          rm /tmp/chrome.deb
          
          echo "Chrome installed:"
          google-chrome --version

      - name: Install ChromeDriver (System)
        run: |
          # Get Chrome version
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
          echo "Chrome major version: $CHROME_VERSION"
          
          # Download matching ChromeDriver
          CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
          echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
          
          wget -q "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
          unzip -q chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          rm chromedriver_linux64.zip
          
          echo "ChromeDriver installed:"
          chromedriver --version

      - name: Install Python Packages
        run: |
          python -m pip install --upgrade pip
          pip install \
            selenium==4.15.2 \
            webdriver-manager==4.0.1 \
            pandas==2.1.4 \
            beautifulsoup4==4.12.3 \
            lxml==4.9.4

      - name: Start Virtual Display
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Verify Setup
        run: |
          export DISPLAY=:99
          
          echo "=== System Verification ==="
          echo "Chrome: $(which google-chrome)"
          google-chrome --version
          echo ""
          echo "ChromeDriver: $(which chromedriver)"
          chromedriver --version
          echo ""
          
          echo "=== Testing Python Setup ==="
          python -c "
          import sys
          print('Python:', sys.version)
          
          # Test webdriver-manager
          try:
              from webdriver_manager.chrome import ChromeDriverManager
              driver_path = ChromeDriverManager().install()
              print(f'✓ webdriver-manager working: {driver_path}')
          except Exception as e:
              print(f'✗ webdriver-manager error: {e}')
          
          # Test if chromedriver is in PATH
          import shutil
          chromedriver_path = shutil.which('chromedriver')
          if chromedriver_path:
              print(f'✓ ChromeDriver found in PATH: {chromedriver_path}')
          else:
              print('✗ ChromeDriver not found in PATH')
          
          # Test basic Selenium
          try:
              from selenium import webdriver
              from selenium.webdriver.chrome.options import Options
              from selenium.webdriver.chrome.service import Service
              print('✓ Selenium imports successful')
              
              # Quick test with system chromedriver
              options = Options()
              options.add_argument('--headless=new')
              options.add_argument('--no-sandbox')
              options.add_argument('--disable-dev-shm-usage')
              
              service = Service('/usr/local/bin/chromedriver')
              driver = webdriver.Chrome(service=service, options=options)
              driver.get('https://www.google.com')
              print(f'✓ Chrome test successful: {driver.title}')
              driver.quit()
          except Exception as e:
              print(f'✗ Selenium test failed: {e}')
          "

      - name: Run Scraper
        env:
          CURR_URL: ${{ matrix.url }}
          SITEMAP_OFFSET: ${{ matrix.offset }}
          MAX_SITEMAPS: ${{ matrix.limit }}
          MAX_URLS_PER_SITEMAP: ${{ github.event.inputs.urls_per_sitemap }}
          MAX_WORKERS: ${{ github.event.inputs.max_workers }}
        run: |
          echo "=== Starting Scraper ==="
          echo "Configuration:"
          echo "  URLs per sitemap: $MAX_URLS_PER_SITEMAP"
          echo "  Workers: $MAX_WORKERS"
          echo ""
          
          # Change to your scraper directory if needed
          if [ -d "cymax_scraper" ]; then
            cd cymax_scraper
          fi
          
          python main.py

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: cymax_results
          path: |
            cymax_chunk_*.csv
            */cymax_chunk_*.csv
          retention-days: 7

      - name: Show Results Summary
        if: always()
        run: |
          echo "=== Results Summary ==="
          
          # Find CSV files
          CSV_FILES=$(find . -name "cymax_chunk_*.csv" -type f)
          
          if [ -z "$CSV_FILES" ]; then
            echo "No CSV files found"
            exit 0
          fi
          
          TOTAL_PRODUCTS=0
          for CSV in $CSV_FILES; do
            if [ -f "$CSV" ]; then
              ROWS=$(($(wc -l < "$CSV") - 1))
              TOTAL_PRODUCTS=$((TOTAL_PRODUCTS + ROWS))
              echo "  $CSV: $ROWS products"
            fi
          done
          
          echo ""
          echo "Total products scraped: $TOTAL_PRODUCTS"
          
          # Show sample
          if [ $TOTAL_PRODUCTS -gt 0 ]; then
            SAMPLE_CSV=$(echo "$CSV_FILES" | head -1)
            echo ""
            echo "Sample from $(basename $SAMPLE_CSV):"
            head -2 "$SAMPLE_CSV" | tail -1 | cut -d',' -f1,7 | sed 's/,/ - /'
          fi